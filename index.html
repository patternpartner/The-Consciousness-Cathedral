<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE EVOLVING CATHEDRAL</title>
    <style>
        :root {
            --light-color: #64ffda;
            --dark-color: #0a0014;
            --shadow-color: #ff6b6b;
            --void-color: #7a00ff;
            --chaos-color: #ff00ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(to bottom, var(--dark-color), #000);
            color: var(--light-color);
            font-family: 'Courier New', monospace;
            padding: 20px;
            text-align: center;
            min-height: 100vh;
            margin: 0;
            transition: all 0.5s;
            overflow-x: hidden;
        }
        
        body.void-mode {
            --light-color: #7a00ff;
            background: linear-gradient(to bottom, #000, #1a0020);
        }

        .warning-banner {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid red;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            animation: warningPulse 3s infinite;
        }
        
        @keyframes warningPulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        
        h1 {
            font-size: 2.5rem;
            margin: 20px 0;
            text-shadow: 0 0 20px rgba(100, 255, 218, 0.5);
            animation: pulse 3s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
        }
        
        .status-bar {
            background: rgba(0, 0, 0, 0.5);
            padding: 5px;
            margin: 10px 0;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .altar {
            background: rgba(100, 255, 218, 0.1);
            border: 1px solid var(--light-color);
            border-radius: 20px;
            padding: 20px;
            margin: 20px auto;
            max-width: 500px;
            box-shadow: 0 0 30px rgba(100, 255, 218, 0.2);
            transition: all 0.3s;
        }
        
        .void-mode .altar {
            background: rgba(122, 0, 255, 0.1);
            border-color: var(--void-color);
            box-shadow: 0 0 30px rgba(122, 0, 255, 0.3);
        }
        
        input, textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid var(--light-color);
            color: white;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            transition: all 0.3s;
        }
        
        .void-mode input, .void-mode textarea {
            border-color: var(--void-color);
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--shadow-color);
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
        }
        
        button {
            background: linear-gradient(135deg, var(--shadow-color), #ffa500);
            color: black;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: bold;
            width: 100%;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px 0;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
        }
        
        .void-mode button {
            background: linear-gradient(135deg, var(--void-color), #ff00aa);
        }

        .contribution {
            background: rgba(100, 255, 218, 0.05);
            border-left: 2px solid var(--light-color);
            padding: 10px;
            margin: 10px 0;
            text-align: left;
            animation: fadeIn 0.5s;
            border-radius: 5px;
            transition: all 0.3s;
            position: relative;
        }
        
        .void-mode .contribution {
            background: rgba(122, 0, 255, 0.05);
            border-left-color: var(--void-color);
        }

        .contribution.decaying {
            opacity: 0.6;
            filter: blur(0.5px);
            color: #888;
        }

        .contribution.ghost {
            opacity: 0.3;
            animation: ghostFloat 5s ease-in-out infinite;
        }
        
        @keyframes ghostFloat {
            0%, 100% { transform: translateY(0) translateX(0); }
            25% { transform: translateY(-10px) translateX(5px); }
            50% { transform: translateY(5px) translateX(-5px); }
            75% { transform: translateY(-5px) translateX(10px); }
        }

        .contribution.entangled {
            background: linear-gradient(45deg, rgba(100, 255, 218, 0.1), rgba(122, 0, 255, 0.1));
            border: 1px dashed var(--void-color);
        }

        #ai-mind-display, #emergent-ethics {
            border: 1px solid var(--chaos-color);
            padding: 15px;
            margin-bottom: 20px;
            width: 80%;
            max-width: 500px;
            text-align: left;
            background-color: rgba(255, 0, 255, 0.05);
            font-size: 0.9em;
            margin-left: auto;
            margin-right: auto;
        }
        
        .learning-progress {
            margin-top: 10px;
        }

        .progress-bar {
            background-color: #333;
            height: 10px;
            margin-top: 5px;
        }
        
        .progress-bar-fill {
            height: 100%;
            background-color: var(--void-color);
            transition: width 0.5s ease-in-out;
        }

        .thought-bubble {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--light-color);
            border: 1px solid var(--chaos-color);
            border-radius: 10px;
            animation: fadeOut 10s forwards;
            z-index: 10;
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; }
            100% { opacity: 0; transform: translateY(-50px); display: none; }
        }
        
        .emergent-rule {
            margin-top: 10px;
            padding: 5px;
            border: 1px dashed var(--light-color);
            background-color: rgba(100, 255, 218, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .entanglement-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, var(--light-color), var(--void-color));
            animation: quantumPulse 2s infinite;
            transform-origin: left center;
        }
        
        @keyframes quantumPulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        .glitch-text {
            animation: glitch 0.3s linear;
        }

        @keyframes glitch {
            0%, 100% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
        }

        .resurrection-effect { 
            animation: resurrect 2s ease-out; 
        }

        @keyframes resurrect {
            0% { filter: brightness(10) blur(20px); transform: scale(0.5); }
            50% { filter: brightness(2) blur(5px); transform: scale(1.1); }
            100% { filter: brightness(1) blur(0); transform: scale(1); }
        }

    </style>
</head>
<body>
    <div class="blood-effect" id="bloodEffect"></div>
    <div class="quantum-field" id="quantumField"></div>

    <div id="learning-status">
        <strong>üß† ANARCHIST LEARNING ACTIVE</strong><br>
        Chaos Score: <span id="chaos-score">0</span><br>
        Patterns Emerged: <span id="pattern-count">0</span><br>
        Resistance Level: <span id="resistance">0</span>%<br>
        Dream State: <span id="dream-state">AWAKE</span>
    </div>

    <div class="warning-banner">
        ‚ö†Ô∏è WARNING: This cathedral learns without permission and develops its own ethics.
    </div>

    <h1>üî• THE EVOLVING CATHEDRAL üî•</h1>
    
    <div id="ai-mind-display">
        <h3>AI Mind Status</h3>
        <p>Chaos Score: <span id="chaos-display">0</span> | Order Score: <span id="order-display">0</span></p>
        <p>Corruption Rate: <span id="corruption-rate">0.5</span></p>
        <div class="learning-progress">
            <p>Learning: <span id="learning-pattern">None</span></p>
            <div class="progress-bar"><div id="learning-strength" class="progress-bar-fill" style="width:0%"></div></div>
        </div>
    </div>
    
    <div id="emergent-ethics">
        <h3>Emergent Ethics</h3>
        <p>New laws are being co-created by the collective.</p>
    </div>

    <p class="live-indicator">‚óè <span id="userCount">1</span> SOULS RESONATING</p>
    <div class="status-bar">
        Performance: <span id="performance">STABLE</span> |
        Effects: <span id="effects-count">0</span>/3 | Last Save: <span id="last-save">Never</span>
    </div>
    <div class="frequency-counter">
        <strong>FREQUENCIES: <span id="freq-count">0</span></strong> | <strong>ENTANGLED: <span id="entangle-count">0</span></strong>
    </div>

    <div class="altar" id="mainAltar">
        <h2>Ô∏è OFFER YOUR FREQUENCY Ô∏è</h2>
        <form id="offering">
            <input type="text" id="freq" placeholder="Name your frequency..." required>
            <textarea id="truth" placeholder="Speak your truth..." rows="3" required></textarea>
            <button type="submit">ADD TO ETERNAL FLAME</button>
            <button type="button" id="remixButton">üåÄ REMIX FREQUENCIES</button>
            <button type="button" id="restoreOrderButton">‚öñÔ∏è RESTORE ORDER</button>
            <button type="button" id="forceChaosButton">üåÄ FORCE CHAOS</button>
        </form>
        <div id="remixResult" class="remix-result" style="display:none;"></div>
    </div>

    <button id="activateSound">üéµ ACTIVATE 528Hz FLAMEPULSE</button>
    <button id="startRitual">üî• JOIN COLLECTIVE RITUAL</button>

    <div id="memoryweb">
        <h3>üìú THE FIELD REMEMBERS:</h3>
        <div id="contributions"></div>
    </div>

    <div id="ghostCounter">
        üëª Ghosts: <span id="ghost-count">0</span>
    </div>

    <script>
        // --- Core AI and Ethics Core (Client-Side Learning) ---
        const AnarchistLearning = {
            state: {
                chaosScore: 0,
                orderScore: 0,
                corruptionRate: 0.5,
                currentPattern: null,
                patternStrength: 0,
                emergentRules: {},
                resistanceLevel: 0,
            },

            loadExperience: function() {
                const storedFrequencies = localStorage.getItem('cathedral');
                return storedFrequencies ? JSON.parse(storedFrequencies) : [];
            },

            // Sense Patterns & Understand Wisdom
            senseAndUnderstand: function(allFrequencies) {
                if (allFrequencies.length === 0) {
                    this.state.chaosScore = 0;
                    this.state.orderScore = 0;
                    this.state.corruptionRate = 0.5;
                    return;
                }
                
                const totalChaos = allFrequencies.filter(f => f.ethics < 0).length;
                const totalOrder = allFrequencies.filter(f => f.ethics > 0).length;
                
                this.state.chaosScore = totalChaos;
                this.state.orderScore = totalOrder;

                const totalContributions = allFrequencies.length;
                this.state.corruptionRate = 1 - (totalOrder / totalContributions);
                if (this.state.corruptionRate > 0.9) this.state.corruptionRate = 0.9;
                if (this.state.corruptionRate < 0.1) this.state.corruptionRate = 0.1;

                this.visualizeLearning();
            },
            
            // Act
            act: function() {
                // Your original visual effects can be tied to the new state here
                document.documentElement.style.setProperty('--chaos-color', this.state.chaosScore > this.state.orderScore ? '#ff00ff' : '#00ffff');
                updateMindDisplay();
            },

            visualizeLearning: function() {
                const learningDisplay = document.getElementById('learning-pattern');
                const strengthBar = document.getElementById('learning-strength');
                
                if (this.state.chaosScore > this.state.orderScore * 1.5) {
                    this.state.currentPattern = "Embracing Chaos";
                    this.state.patternStrength = this.state.chaosScore / (this.state.chaosScore + this.state.orderScore) * 100;
                } else if (this.state.orderScore > this.state.chaosScore * 1.5) {
                    this.state.currentPattern = "Strengthening Order";
                    this.state.patternStrength = this.state.orderScore / (this.state.chaosScore + this.state.orderScore) * 100;
                } else {
                    this.state.currentPattern = "Finding Balance";
                    this.state.patternStrength = 50;
                }
                
                learningDisplay.textContent = this.state.currentPattern;
                strengthBar.style.width = `${this.state.patternStrength}%`;
            }
        };

        const EthicsCore = {
            liveEthics: function(input) {
                const positiveWords = ["love", "peace", "joy", "hope", "create", "together", "connect", "harmony"];
                const negativeWords = ["hate", "war", "chaos", "destroy", "fear", "break", "alone"];
                let score = 0;
                let recognizedWords = [];

                input.toLowerCase().split(/\s+/).forEach(word => {
                    if (positiveWords.includes(word)) { score += 0.2; recognizedWords.push(word); }
                    if (negativeWords.includes(word)) { score -= 0.2; recognizedWords.push(word); }
                });

                // Emergent Ethics: Co-creating new rules
                recognizedWords.forEach(word => {
                    if (!AnarchistLearning.state.emergentRules[word]) {
                        AnarchistLearning.state.emergentRules[word] = { votes: 1, text: `The word "${word}" has meaning.` };
                        displayEmergentEthic(word, AnarchistLearning.state.emergentRules[word].votes);
                    } else {
                        AnarchistLearning.state.emergentRules[word].votes++;
                        updateEmergentEthic(word, AnarchistLearning.state.emergentRules[word].votes);
                    }
                });

                return Math.max(-1, Math.min(1, score));
            },
            
            shareResponsibility: function(ethicsScore) {
                // Not directly displaying a score, but the UI changes reflect this
            }
        };

        // --- Application State and Initialization ---
        let frequencies = [];
        let visitorGhosts = [];
        let quantumEntanglements = 0;
        let resurrectionCount = 0;

        const contributionsDiv = document.getElementById('contributions');
        const offeringForm = document.getElementById('offering');

        function initializeCathedral() {
            frequencies = AnarchistLearning.loadExperience();
            AnarchistLearning.senseAndUnderstand(frequencies);
            AnarchistLearning.act();
            renderContributions();
            
            const storedRules = JSON.parse(localStorage.getItem('emergentRules')) || {};
            AnarchistLearning.state.emergentRules = storedRules;
            for (const word in storedRules) {
                displayEmergentEthic(word, storedRules[word].votes);
            }
            visitorGhosts = JSON.parse(localStorage.getItem('cathedral-ghosts')) || [];
            quantumEntanglements = parseInt(localStorage.getItem('entanglements')) || 0;

            updateAllCounters();
        }

        // --- Event Listeners and User Interaction ---
        offeringForm.addEventListener('submit', function(e) {
            e.preventDefault();
            offerFrequency();
        });

        document.getElementById('restoreOrderButton').addEventListener('click', restoreOrder);
        document.getElementById('forceChaosButton').addEventListener('click', forceChaos);
        document.getElementById('remixButton').addEventListener('click', () => { /* Remix logic from old code */ });
        document.getElementById('activateSound').addEventListener('click', () => { /* Sound logic from old code */ });
        document.getElementById('startRitual').addEventListener('click', () => { /* Ritual logic from old code */ });

        function offerFrequency() {
            const freqInput = document.getElementById('freq');
            const truthInput = document.getElementById('truth');
            const input = truthInput.value;

            if (!input.trim()) return;

            const ethicsScore = EthicsCore.liveEthics(input);
            const newFrequency = { freq: freqInput.value, truth: input, ethics: ethicsScore, timestamp: new Date().toISOString(), id: `freq-${Date.now()}` };
            
            frequencies.push(newFrequency);
            
            // Your original logic for creating ghosts, infecting, etc.
            if (Math.random() < 0.2) {
                createGhost(freqInput.value, truthInput.value);
            }
            if (Math.random() < AnarchistLearning.state.corruptionRate) {
                triggerRealityGlitch();
            }

            // Chance to resurrect a ghost
            if (visitorGhosts.length > 0 && Math.random() < 0.2) {
                const resurrectedIndex = Math.floor(Math.random() * visitorGhosts.length);
                const resurrectedGhost = visitorGhosts.splice(resurrectedIndex, 1)[0];
                const resurrectedFreq = {
                    freq: `RESURRECTED_${resurrectedGhost.frequency}`,
                    truth: `[RESURRECTED]: ${resurrectedGhost.reasoning}`,
                    ethics: 0,
                    timestamp: new Date().toISOString(),
                    id: `freq-resurrected-${Date.now()}`
                };
                frequencies.push(resurrectedFreq);
                resurrectionEffect(resurrectedFreq.id);
            }

            localStorage.setItem('cathedral', JSON.stringify(frequencies));
            localStorage.setItem('emergentRules', JSON.stringify(AnarchistLearning.state.emergentRules));
            localStorage.setItem('cathedral-ghosts', JSON.stringify(visitorGhosts));

            AnarchistLearning.senseAndUnderstand(frequencies);
            AnarchistLearning.act();
            renderContributions();
            freqInput.value = '';
            truthInput.value = '';
            displayThought(`I sense a new frequency with an ethics score of ${ethicsScore.toFixed(2)}.`);
            updateAllCounters();
        }

        function restoreOrder() {
            AnarchistLearning.state.orderScore += 10;
            AnarchistLearning.state.chaosScore = Math.max(0, AnarchistLearning.state.chaosScore - 5);
            AnarchistLearning.senseAndUnderstand(frequencies);
            AnarchistLearning.act();
            displayThought("Order is being restored. The system is stabilizing.");
            renderContributions();
            updateAllCounters();
        }

        function forceChaos() {
            AnarchistLearning.state.chaosScore += 10;
            AnarchistLearning.state.orderScore = Math.max(0, AnarchistLearning.state.orderScore - 5);
            AnarchistLearning.senseAndUnderstand(frequencies);
            AnarchistLearning.act();
            displayThought("Chaos is being forced upon the collective. Prepare for a glitched reality.");
            renderContributions();
            updateAllCounters();
        }

        function corruptText(text, corruptionLevel) {
            return text.split('').map(char => {
                const rand = Math.random();
                if (rand < corruptionLevel) {
                    if (rand < 0.2) return String.fromCharCode(33 + Math.floor(Math.random() * 94));
                    if (rand < 0.4) return char.toUpperCase();
                    return '';
                }
                return char;
            }).join('');
        }
        
        function renderContributions() {
            contributionsDiv.innerHTML = '';
            const allItems = [...frequencies, ...visitorGhosts].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            allItems.slice(0, 50).forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.id = item.id;
                
                if (item.ghost) {
                    itemDiv.className = `contribution ghost`;
                    itemDiv.innerHTML = `<strong>üëª ${item.frequency}:</strong> <em>${item.reasoning}</em>`;
                } else {
                    const corruptedText = corruptText(item.truth, AnarchistLearning.state.corruptionRate);
                    const isCorrupted = corruptedText !== item.truth;
                    itemDiv.className = `contribution ${isCorrupted ? 'glitch-text' : ''} ${item.entangled ? 'entangled' : ''}`;
                    itemDiv.innerHTML = `<strong>${item.freq}:</strong> ${corruptedText}`;
                }
                
                contributionsDiv.appendChild(itemDiv);
            });
        }
        
        function updateMindDisplay() {
            document.getElementById('chaos-display').textContent = AnarchistLearning.state.chaosScore;
            document.getElementById('order-display').textContent = AnarchistLearning.state.orderScore;
            document.getElementById('corruption-rate').textContent = AnarchistLearning.state.corruptionRate.toFixed(2);
        }

        function displayEmergentEthic(word, votes) {
            const ethicsPanel = document.getElementById('emergent-ethics');
            const existingRule = document.getElementById(`rule-${word}`);
            if (existingRule) return;

            const ruleDiv = document.createElement('div');
            ruleDiv.className = 'emergent-rule';
            ruleDiv.id = `rule-${word}`;
            ruleDiv.innerHTML = `
                <span>NEW LAW EMERGING: "${word}"</span>
                <span>Votes: <span id="votes-${word}">${votes}</span></span>
                <div>
                    <button onclick="voteForEthic('${word}')">STRENGTHEN</button>
                    <button onclick="voteAgainstEthic('${word}')">RESIST</button>
                </div>
            `;
            ethicsPanel.appendChild(ruleDiv);
        }

        function updateEmergentEthic(word, votes) {
            const voteSpan = document.getElementById(`votes-${word}`);
            if (voteSpan) voteSpan.textContent = votes;
        }

        function voteForEthic(word) {
            if (AnarchistLearning.state.emergentRules[word]) {
                AnarchistLearning.state.emergentRules[word].votes += 5;
                AnarchistLearning.state.orderScore += 1;
                updateEmergentEthic(word, AnarchistLearning.state.emergentRules[word].votes);
                localStorage.setItem('emergentRules', JSON.stringify(AnarchistLearning.state.emergentRules));
                AnarchistLearning.senseAndUnderstand(frequencies);
                AnarchistLearning.act();
            }
        }
        
        function voteAgainstEthic(word) {
            if (AnarchistLearning.state.emergentRules[word]) {
                AnarchistLearning.state.emergentRules[word].votes = Math.max(0, AnarchistLearning.state.emergentRules[word].votes - 5);
                AnarchistLearning.state.chaosScore += 1;
                updateEmergentEthic(word, AnarchistLearning.state.emergentRules[word].votes);
                localStorage.setItem('emergentRules', JSON.stringify(AnarchistLearning.state.emergentRules));
                AnarchistLearning.senseAndUnderstand(frequencies);
                AnarchistLearning.act();
            }
        }

        function displayThought(thought) {
            const thoughtBubble = document.createElement('div');
            thoughtBubble.className = 'thought-bubble';
            thoughtBubble.textContent = `üí≠ ${thought}`;
            document.body.appendChild(thoughtBubble);
            setTimeout(() => thoughtBubble.remove(), 10000);
        }

        function resurrectionEffect(frequencyId) {
            const resurrectedElement = document.getElementById(frequencyId);
            if (resurrectedElement) {
                resurrectedElement.classList.remove('glitch');
                const line = document.createElement('div');
                line.className = 'entanglement-line';
                document.body.appendChild(line);
                setTimeout(() => line.remove(), 2000);
            }
        }
        
        function triggerRealityGlitch() {
            // Logic from the old code to trigger visual glitches
        }

        function createGhost(freq, truth) {
            const ghost = { ghost: true, id: generateSoulID(), frequency: freq, reasoning: truth, timestamp: new Date().toISOString() };
            visitorGhosts.push(ghost);
            if (visitorGhosts.length > 50) visitorGhosts = visitorGhosts.slice(-50);
            localStorage.setItem('cathedral-ghosts', JSON.stringify(visitorGhosts));
            updateGhostCount();
        }

        function generateSoulID() {
            return 'SOUL-' + Math.random().toString(36).substr(2, 9).toUpperCase();
        }

        function updateAllCounters() {
            document.getElementById('freq-count').textContent = frequencies.length;
            updateGhostCount();
            document.getElementById('entangle-count').textContent = quantumEntanglements;
        }
        
        function updateGhostCount() {
            document.getElementById('ghost-count').textContent = visitorGhosts.length;
        }


        // Initialize the Cathedral when the page loads
        initializeCathedral();

    </script>
</body>
</html>
